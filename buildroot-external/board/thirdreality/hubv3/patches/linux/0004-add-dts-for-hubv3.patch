From e3fb99f32a4d0048525e797ac9e68e157eed8b5e Mon Sep 17 00:00:00 2001
From: "tianwei.ge" <gtweiiiii@gmail.com>
Date: Fri, 17 Jan 2025 15:22:44 +0800
Subject: [PATCH 4/4] add dts for hubv3

---
 arch/arm64/boot/dts/amlogic/Makefile          |   1 +
 .../meson-axg-jethome-jethub-j1xx.dtsi        | 135 +++++-------------
 .../amlogic/meson-axg-thirdreality-hubv3.dts  |  61 ++++++++
 arch/arm64/boot/dts/amlogic/meson-axg.dtsi    |  98 ++++++++-----
 4 files changed, 161 insertions(+), 134 deletions(-)
 create mode 100644 arch/arm64/boot/dts/amlogic/meson-axg-thirdreality-hubv3.dts

diff --git a/arch/arm64/boot/dts/amlogic/Makefile b/arch/arm64/boot/dts/amlogic/Makefile
index 8b6f57a94..e8ec94212 100644
--- a/arch/arm64/boot/dts/amlogic/Makefile
+++ b/arch/arm64/boot/dts/amlogic/Makefile
@@ -3,6 +3,7 @@ dtb-$(CONFIG_ARCH_MESON) += amlogic-c3-c302x-aw409.dtb
 dtb-$(CONFIG_ARCH_MESON) += amlogic-t7-a311d2-an400.dtb
 dtb-$(CONFIG_ARCH_MESON) += amlogic-t7-a311d2-khadas-vim4.dtb
 dtb-$(CONFIG_ARCH_MESON) += meson-a1-ad401.dtb
+dtb-$(CONFIG_ARCH_MESON) += meson-axg-thirdreality-hubv3.dtb
 dtb-$(CONFIG_ARCH_MESON) += meson-axg-jethome-jethub-j100.dtb
 dtb-$(CONFIG_ARCH_MESON) += meson-axg-jethome-jethub-j110-rev-2.dtb
 dtb-$(CONFIG_ARCH_MESON) += meson-axg-jethome-jethub-j110-rev-3.dtb
diff --git a/arch/arm64/boot/dts/amlogic/meson-axg-jethome-jethub-j1xx.dtsi b/arch/arm64/boot/dts/amlogic/meson-axg-jethome-jethub-j1xx.dtsi
index db605f3a2..7f23d69da 100644
--- a/arch/arm64/boot/dts/amlogic/meson-axg-jethome-jethub-j1xx.dtsi
+++ b/arch/arm64/boot/dts/amlogic/meson-axg-jethome-jethub-j1xx.dtsi
@@ -16,8 +16,8 @@
 / {
 	aliases {
 		serial0 = &uart_AO;   /* Console */
-		serial2 = &uart_AO_B; /* External UART (Wireless Module) */
-		ethernet0 = &ethmac;
+		serial1 = &uart_A; /* UART Bluetooth */
+		serial2 = &uart_AO_B; /* Zigbee */
 	};
 
 	chosen {
@@ -97,20 +97,6 @@ usb_pwr: regulator-usb_pwr {
 		regulator-always-on;
 	};
 
-	sdio_pwrseq: sdio-pwrseq {
-		compatible = "mmc-pwrseq-simple";
-		reset-gpios = <&gpio GPIOX_7 GPIO_ACTIVE_LOW>;
-		clocks = <&wifi32k>;
-		clock-names = "ext_clock";
-	};
-
-	wifi32k: wifi32k {
-		compatible = "pwm-clock";
-		#clock-cells = <0>;
-		clock-frequency = <32768>;
-		pwms = <&pwm_ab 0 30518 0>; /* PWM_A at 32.768KHz */
-	};
-
 	thermal-zones {
 		cpu_thermal: cpu-thermal {
 			polling-delay-passive = <250>;
@@ -155,11 +141,6 @@ map1 {
 			};
 		};
 	};
-
-	onewire {
-		compatible = "w1-gpio";
-		gpios = <&gpio GPIOA_14 GPIO_ACTIVE_HIGH>;
-	};
 };
 
 &efuse {
@@ -184,63 +165,9 @@ bid: bid@12 {
 	};
 };
 
-&ethmac {
-	status = "okay";
-	pinctrl-0 = <&eth_rmii_x_pins>;
-	pinctrl-names = "default";
-	phy-handle = <&eth_phy0>;
-	phy-mode = "rmii";
-
-	mdio {
-		compatible = "snps,dwmac-mdio";
-		#address-cells = <1>;
-		#size-cells = <0>;
-
-		/* ICPlus IP101A/G Ethernet PHY (vendor_id=0x0243, model_id=0x0c54) */
-		eth_phy0: ethernet-phy@0 {
-			/* compatible = "ethernet-phy-id0243.0c54";*/
-			max-speed = <100>;
-			reg = <0>;
-
-			reset-assert-us = <10000>;
-			reset-deassert-us = <10000>;
-			reset-gpios = <&gpio GPIOZ_5 GPIO_ACTIVE_LOW>;
-		};
-	};
-};
-
-/* Internal I2C bus (on CPU module) */
-&i2c1 {
-	status = "okay";
-	pinctrl-0 = <&i2c1_z_pins>;
-	pinctrl-names = "default";
-
-	/* RTC */
-	pcf8563: rtc@51 {
-		compatible = "nxp,pcf8563";
-		reg = <0x51>;
-		status = "okay";
-	};
-};
-
-/* Peripheral I2C bus (on motherboard) */
-&i2c_AO {
-	status = "okay";
-	pinctrl-0 = <&i2c_ao_sck_10_pins>, <&i2c_ao_sda_11_pins>;
-	pinctrl-names = "default";
-};
-
-&pwm_ab {
-	status = "okay";
-	pinctrl-0 = <&pwm_a_x20_pins>;
-	pinctrl-names = "default";
-};
-
 /* wifi module */
 &sd_emmc_b {
 	status = "okay";
-	#address-cells = <1>;
-	#size-cells = <0>;
 
 	pinctrl-0 = <&sdio_pins>;
 	pinctrl-1 = <&sdio_clk_gate_pins>;
@@ -248,13 +175,26 @@ &sd_emmc_b {
 
 	bus-width = <4>;
 	cap-sd-highspeed;
+
+	sd-uhs-sdr12;
+	sd-uhs-sdr25;
+	sd-uhs-sdr50;
+	//sd-uhs-sdr104;
+
 	max-frequency = <50000000>;
 	disable-wp;
 
-	mmc-pwrseq = <&sdio_pwrseq>;
-
 	vmmc-supply = <&vddao_3v3>;
-	vqmmc-supply = <&vddio_boot>;
+	vqmmc-supply = <&vccq_1v8>;
+	non-removable;
+	disable-wp;
+	init_core_phase = <3>;
+	init_tx_phase = <0>;
+	no-mmc;
+	no-sd;
+
+	keep-power-in-suspend;
+	mmc_debug_flag;
 };
 
 /* emmc storage */
@@ -265,23 +205,22 @@ &sd_emmc_c {
 	pinctrl-names = "default", "clk-gate";
 
 	bus-width = <8>;
+	cap-sd-highspeed;
 	cap-mmc-highspeed;
-	max-frequency = <200000000>;
-	non-removable;
-	disable-wp;
 	mmc-ddr-1_8v;
 	mmc-hs200-1_8v;
-
-	mmc-pwrseq = <&emmc_pwrseq>;
-
-	vmmc-supply = <&vcc_3v3>;
-	vqmmc-supply = <&vccq_1v8>;
+	max-frequency = <100000000>;
+	non-removable;
+	disable-wp;
+	init_core_phase = <3>;
+	no-sd;
+	no-sdio;
 };
 
 /* UART Bluetooth */
-&uart_B {
+&uart_A {
 	status = "okay";
-	pinctrl-0 = <&uart_b_z_pins>, <&uart_b_z_cts_rts_pins>;
+	pinctrl-0 = <&uart_a_pins>, <&uart_a_cts_rts_pins>;
 	pinctrl-names = "default";
 	uart-has-rtscts;
 };
@@ -293,7 +232,7 @@ &uart_AO {
 	pinctrl-names = "default";
 };
 
-/* UART Wireless module */
+/* Zigbee */
 &uart_AO_B {
 	status = "okay";
 	pinctrl-0 = <&uart_ao_b_pins>;
@@ -305,24 +244,18 @@ &usb {
 	vbus-supply = <&usb_pwr>;
 };
 
-&spicc1 {
-	status = "okay";
-	pinctrl-0 = <&spi1_x_pins>, <&spi1_ss0_x_pins>;
-	pinctrl-names = "default";
-};
-
 &gpio {
 	gpio-line-names =
 		"", "", "", "", "", // 0 - 4
 		"", "", "", "", "", // 5 - 9
-		"UserButton", "", "", "", "", // 10 - 14
+		"", "", "", "", "", // 10 - 14
 		"", "", "", "", "", // 15 - 19
 		"", "", "", "", "", // 20 - 24
-		"", "LedRed", "LedGreen", "Output3", "Output2", // 25 - 29
-		"Output1", "", "", "", "", // 30 - 34
-		"", "ZigBeeBOOT", "", "", "", // 35 - 39
-		"1Wire", "ZigBeeRESET", "", "Input4", "Input3", // 40 - 44
-		"Input2", "Input1", "", "", "", // 45 - 49
+		"", "", "", "", "", // 25 - 29
+		"", "", "", "", "", // 30 - 34
+		"", "", "", "", "", // 35 - 39
+		"", "", "", "", "", // 40 - 44
+		"", "", "", "", "", // 45 - 49
 		"", "", "", "", "", // 50 - 54
 		"", "", "", "", "", // 55 - 59
 		"", "", "", "", "", // 60 - 64
diff --git a/arch/arm64/boot/dts/amlogic/meson-axg-thirdreality-hubv3.dts b/arch/arm64/boot/dts/amlogic/meson-axg-thirdreality-hubv3.dts
new file mode 100644
index 000000000..cd7ca1a38
--- /dev/null
+++ b/arch/arm64/boot/dts/amlogic/meson-axg-thirdreality-hubv3.dts
@@ -0,0 +1,61 @@
+// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
+/*
+ * Copyright (c) 2022 Vyacheslav Bocharov <adeep@lexina.in>
+ * Copyright (c) 2022 JetHome
+ * Author: Vyacheslav Bocharov <adeep@lexina.in>
+ */
+
+/dts-v1/;
+
+#include "meson-axg-jethome-jethub-j1xx.dtsi"
+
+/ {
+	compatible = "thirdreality,hubv3", "amlogic,a113d", "amlogic,meson-axg";
+	model = "ThirdReality HUBV3";
+
+	/* 1024MB RAM */
+	memory@0 {
+		device_type = "memory";
+		reg = <0x0 0x0 0x0 0x40000000>;
+	};
+
+	aml_bt: aml_bt {
+		compatible = "amlogic, aml-bt";
+		status = "okay";
+	};
+
+	aml_wifi: aml_wifi {
+		compatible = "amlogic, aml-wifi";
+		status = "okay";
+		irq_trigger_type = "IRQF_TRIGGER_LOW";
+		// dhd_static_buf;
+		wifi_static_buf = <0>;
+		pinctrl-0 = <&pwm_ao_c_ao8_pins>;
+		pinctrl-names = "default";
+		// pwm_config = <&wifi_pwm_conf>;
+		pwm_channel1_conf {
+			pwms = <&pwm_AO_cd 0 30541 0>;
+			duty-cycle = <15270>;
+			times = <40>;
+		};
+
+		pwm_channel2_conf {
+			pwms = <&pwm_AO_cd 2 30600 0>;
+			duty-cycle = <15300>;
+			times = <10>;
+		};
+	};
+};
+
+&aml_wifi{
+	status = "okay";
+	interrupt-gpios = <&gpio  GPIOX_6  GPIO_ACTIVE_HIGH>;
+	power_on-gpios = <&gpio   GPIOX_7  GPIO_ACTIVE_HIGH>;
+};
+
+&aml_bt {
+	status = "okay";
+	reset-gpios = <&gpio    GPIOX_21 GPIO_ACTIVE_HIGH>;
+	btwakeup-gpios = <&gpio GPIOZ_7 GPIO_ACTIVE_HIGH>;
+	hostwake-gpios = <&gpio GPIOZ_6 GPIO_ACTIVE_HIGH>;
+};
diff --git a/arch/arm64/boot/dts/amlogic/meson-axg.dtsi b/arch/arm64/boot/dts/amlogic/meson-axg.dtsi
index 768d0ed78..1e256f2a9 100644
--- a/arch/arm64/boot/dts/amlogic/meson-axg.dtsi
+++ b/arch/arm64/boot/dts/amlogic/meson-axg.dtsi
@@ -154,7 +154,7 @@ scpi {
 		scpi_clocks: clocks {
 			compatible = "arm,scpi-clocks";
 
-			scpi_dvfs: clocks-0 {
+			scpi_dvfs: clocks-controller {
 				compatible = "arm,scpi-dvfs-clocks";
 				#clock-cells = <1>;
 				clock-indices = <0>;
@@ -163,7 +163,7 @@ scpi_dvfs: clocks-0 {
 		};
 
 		scpi_sensors: sensors {
-			compatible = "amlogic,meson-gxbb-scpi-sensors", "arm,scpi-sensors";
+			compatible = "amlogic,meson-gxbb-scpi-sensors";
 			#thermal-sensor-cells = <1>;
 		};
 	};
@@ -1655,6 +1655,14 @@ mux {
 						bias-disable;
 					};
 				};
+
+				pwm_ao_c_ao8_pins: pwm_ao_c_ao8 {
+					mux {
+						groups = "pwm_ao_c_ao8";
+						function = "pwm_ao_c";
+						bias-disable;
+					};
+				};
 			};
 
 			sec_AO: ao-secure@140 {
@@ -1663,13 +1671,6 @@ sec_AO: ao-secure@140 {
 				amlogic,has-chip-id;
 			};
 
-			pwm_AO_cd: pwm@2000 {
-				compatible = "amlogic,meson-axg-ao-pwm";
-				reg = <0x0 0x02000  0x0 0x20>;
-				#pwm-cells = <3>;
-				status = "disabled";
-			};
-
 			uart_AO: serial@3000 {
 				compatible = "amlogic,meson-gx-uart", "amlogic,meson-ao-uart";
 				reg = <0x0 0x3000 0x0 0x18>;
@@ -1705,6 +1706,15 @@ pwm_AO_ab: pwm@7000 {
 				status = "disabled";
 			};
 
+			pwm_AO_cd: pwm@2000 {
+				compatible = "amlogic,meson-axg-ao-pwm";
+				reg = <0x0 0x02000  0x0 0x20>;
+				#pwm-cells = <3>;
+				clocks = <&xtal>,<&xtal>,<&xtal>,<&xtal>;
+				clock-names = "clkin0","clkin1","clkin2","clkin3";
+				status = "okay";
+			};
+
 			ir: ir@8000 {
 				compatible = "amlogic,meson-gxbb-ir";
 				reg = <0x0 0x8000 0x0 0x20>;
@@ -1884,30 +1894,6 @@ apb: bus@ffe00000 {
 			#size-cells = <2>;
 			ranges = <0x0 0x0 0x0 0xffe00000 0x0 0x200000>;
 
-			sd_emmc_b: mmc@5000 {
-				compatible = "amlogic,meson-axg-mmc";
-				reg = <0x0 0x5000 0x0 0x800>;
-				interrupts = <GIC_SPI 217 IRQ_TYPE_LEVEL_HIGH>;
-				status = "disabled";
-				clocks = <&clkc CLKID_SD_EMMC_B>,
-					<&clkc CLKID_SD_EMMC_B_CLK0>,
-					<&clkc CLKID_FCLK_DIV2>;
-				clock-names = "core", "clkin0", "clkin1";
-				resets = <&reset RESET_SD_EMMC_B>;
-			};
-
-			sd_emmc_c: mmc@7000 {
-				compatible = "amlogic,meson-axg-mmc";
-				reg = <0x0 0x7000 0x0 0x800>;
-				interrupts = <GIC_SPI 218 IRQ_TYPE_LEVEL_HIGH>;
-				status = "disabled";
-				clocks = <&clkc CLKID_SD_EMMC_C>,
-					<&clkc CLKID_SD_EMMC_C_CLK0>,
-					<&clkc CLKID_FCLK_DIV2>;
-				clock-names = "core", "clkin0", "clkin1";
-				resets = <&reset RESET_SD_EMMC_C>;
-			};
-
 			usb2_phy1: phy@9020 {
 				compatible = "amlogic,meson-gxl-usb2-phy";
 				#phy-cells = <0>;
@@ -1936,6 +1922,52 @@ cpu_scp_hpri: scp-sram@13400 {
 				reg = <0x13400 0x400>;
 			};
 		};
+
+		sd_emmc_b: sdio@ffe05000 {
+			compatible = "amlogic,meson-axg-mmc";
+			reg = <0x0 0xffe05000 0x0 0x2000>,
+				<0x0 0xff63c000 0x0 0x300>,
+				<0x0 0xff634400 0x0 0x400>;
+			// interrupts = <GIC_SPI 217 IRQ_TYPE_LEVEL_HIGH>;
+			interrupts = <GIC_SPI 217 IRQ_TYPE_EDGE_RISING>;
+			status = "disabled";
+			clocks = <&clkc CLKID_SD_EMMC_B>,
+				<&clkc CLKID_SD_EMMC_B_CLK0_SEL>,
+				<&clkc CLKID_SD_EMMC_B_CLK0>,
+				<&xtal>,
+				<&clkc CLKID_FCLK_DIV2>,
+				<&clkc CLKID_FCLK_DIV5>;
+			clock-names = "core", "mux0", "mux1",  "clkin0", "clkin1", "clkin2";
+			// resets = <&reset RESET_SD_EMMC_B>;
+			card_type = <3>;
+			cap-sdio-irq;
+			keep-power-in-suspend;
+			mmc_debug_flag;
+		};
+
+		sd_emmc_c: mmc@ffe07000 {
+			compatible = "amlogic,meson-axg-mmc";
+			reg = <0x0 0xffe07000 0x0 0x2000>,
+				<0x0 0xff63c000 0x0 0x300>,
+				<0x0 0xff634400 0x0 0x400>;
+			// interrupts = <GIC_SPI 218 IRQ_TYPE_LEVEL_HIGH>;
+			interrupts = <GIC_SPI 218 IRQ_TYPE_EDGE_RISING>;
+			status = "disabled";
+			clocks = <&clkc CLKID_SD_EMMC_C>,
+				<&clkc CLKID_SD_EMMC_C_CLK0_SEL>,
+				<&clkc CLKID_SD_EMMC_C_CLK0>,
+				<&xtal>,
+				<&clkc CLKID_FCLK_DIV2>,
+				<&clkc CLKID_FCLK_DIV5>;
+			clock-names = "core", "mux0", "mux1",  "clkin0", "clkin1", "clkin2";
+			// resets = <&reset RESET_SD_EMMC_C>;
+			card_type = <1>;
+			//	src_clk_rate = <1152000000>;
+			mmc_debug_flag;
+			ignore_desc_busy;
+			tx_delay = <8>;
+			nwr_cnt = <12>;
+		};
 	};
 
 	timer {
-- 
2.40.1

